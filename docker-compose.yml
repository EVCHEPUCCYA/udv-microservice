version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - services-network

  apigateway:
    build:
      context: .
      dockerfile: ./ApiGateway/Dockerfile
    ports:
      - "5000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Services__UserService=http://userservice:8080
      - Services__OrderService=http://orderservice:8080
      - Services__ProductService=http://productservice:8080
      - Services__UserServiceGrpc=http://userservice:8081
      - Services__OrderServiceGrpc=http://orderservice:8081
      - Services__ProductServiceGrpc=http://productservice:8081
      - Services__UseGrpc=true
      - Redis__ConnectionString=redis:6379
    depends_on:
      - userservice
      - orderservice
      - productservice
      - redis
    networks:
      - services-network

  userservice:
    build:
      context: ./UserService
      dockerfile: Dockerfile
    ports:
      - "5001:8080"
      - "5004:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - services-network

  orderservice:
    build:
      context: ./OrderService
      dockerfile: Dockerfile
    ports:
      - "5002:8080"
      - "5005:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - services-network

  productservice:
    build:
      context: ./ProductService
      dockerfile: Dockerfile
    ports:
      - "5003:8080"
      - "5006:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - services-network

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - services-network

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - services-network

volumes:
  redis-data:
  prometheus-data:
  grafana-data:

networks:
  services-network:
    driver: bridge


